<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ§µ Ù…Ø­ÙˆÙ„ ØµÙˆØ± â†’ Ù…Ø®Ø·Ø· ØªØ·Ø±ÙŠØ²</title>
  <style>
    body{font-family:system-ui,Arial;direction:rtl;padding:16px;background:#f7f7fb;color:#111}
    h1{font-size:22px;margin-bottom:8px}
    label{display:block;margin:8px 0 4px}
    input,button{font-size:14px;padding:8px;margin-top:4px}
    #preview,#original{border:1px solid #ddd;background:#fff;display:block;margin-top:12px;max-width:100%}
    .row{margin-bottom:12px}
    .controls{display:flex;flex-wrap:wrap;gap:12px}
    .item{border:1px solid #ccc;padding:8px;margin:8px 0;background:#fff;border-radius:6px}
    iframe{border:none;margin-top:6px}
  </style>
</head>
<body>
  <h1>ğŸ§µ Ù…Ø­ÙˆÙ„ ØµÙˆØ± â†’ Ù…Ø®Ø·Ø· ØªØ·Ø±ÙŠØ²</h1>

  <div class="row">
    <label>Ø§Ø®ØªØ± ØµÙˆØ±Ø©:</label>
    <input id="imgfile" type="file" accept="image/*" />
  </div>

  <div class="row controls">
    <div>
      <label>Ø­Ø¬Ù… Ø§Ù„Ø®Ù„ÙŠØ©</label>
      <input id="cellSize" type="number" value="8" min="2" max="40" />
    </div>
    <div style="align-self:flex-end">
      <button id="convert">ØªØ­ÙˆÙŠÙ„ ÙˆØ±ÙØ¹</button>
    </div>
  </div>

  <canvas id="hiddenCanvas" style="display:none"></canvas>

  <div class="row">
    <label>Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:</label>
    <img id="original" alt="original" />
  </div>

  <div class="row">
    <label>Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ù†Ø§ØªØ¬:</label>
    <img id="preview" alt="preview" />
    <a id="downloadLink" style="display:none" download="pattern.svg">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø®Ø·Ø·</a>
  </div>

  <h2>ğŸ“‚ Ø§Ù„Ù…Ø®Ø·Ø·Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©</h2>
  <div id="list">â€” Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ â€”</div>

  <script>
    function readImageFile(file){
      return new Promise((res,rej)=>{
        const fr=new FileReader();
        fr.onload=e=>{
          const img=new Image();
          img.onload=()=>res(img);
          img.onerror=rej;
          img.src=e.target.result;
        };
        fr.onerror=rej;
        fr.readAsDataURL(file);
      });
    }
    function rgbToHex(r,g,b){return '#'+[r,g,b].map(x=>x.toString(16).padStart(2,'0')).join('');}

    async function convertImage(img, cellSize){
      const iw=Math.floor(img.width/cellSize)*cellSize;
      const ih=Math.floor(img.height/cellSize)*cellSize;
      const c=document.getElementById('hiddenCanvas');
      c.width=iw; c.height=ih;
      const ctx=c.getContext('2d');
      ctx.drawImage(img,0,0,iw,ih);

      let svg = `<?xml version="1.0"?>\n<svg xmlns='http://www.w3.org/2000/svg' width='${iw}' height='${ih}'>\n<rect width='100%' height='100%' fill='white'/>`;
      const imgData = ctx.getImageData(0,0,iw,ih).data;
      for(let y=0;y<ih;y+=cellSize){
        for(let x=0;x<iw;x+=cellSize){
          const i=((y*iw)+x)*4;
          const r=imgData[i],g=imgData[i+1],b=imgData[i+2];
          const hex = rgbToHex(r,g,b);
          svg+=`<rect x='${x}' y='${y}' width='${cellSize}' height='${cellSize}' fill='${hex}'/>`;
        }
      }
      svg+="</svg>";
      const csv="x,y\n0,0"; 
      return {svg,csv};
    }

    const fileInput=document.getElementById('imgfile');
    const original=document.getElementById('original');
    let lastImg=null;
    fileInput.addEventListener('change',async e=>{
      const f=e.target.files[0];if(!f)return;
      const img=await readImageFile(f);
      lastImg=img;
      original.src=img.src;
    });
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, orderBy, query } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBeTM1iOZsIZy9Sf0YfQlOVO3uJBt4NGwI",
      authDomain: "hfars-aa1ac.firebaseapp.com",
      projectId: "hfars-aa1ac",
      storageBucket: "hfars-aa1ac.appspot.com",
      messagingSenderId: "664139243924",
      appId: "1:664139243924:web:36e77783dbeb9667e3ef81",
      measurementId: "G-15SFEZQZ6Y"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    async function uploadToFirebase(fileBlob, fileName) {
      const storageRef = ref(storage, "patterns/" + fileName);
      await uploadBytes(storageRef, fileBlob);
      return await getDownloadURL(storageRef);
    }

    async function savePattern(svgBlob, csvBlob) {
      const svgUrl = await uploadToFirebase(svgBlob, "pattern-"+Date.now()+".svg");
      const csvUrl = await uploadToFirebase(csvBlob, "pattern-"+Date.now()+".csv");
      await addDoc(collection(db,"patterns"),{svg:svgUrl,csv:csvUrl,createdAt:new Date().toISOString()});
      return {svgUrl,csvUrl};
    }

    async function loadPatterns(){
      const q=query(collection(db,"patterns"),orderBy("createdAt","desc"));
      const snap=await getDocs(q);
      const list=document.getElementById("list");
      list.innerHTML="";
      snap.forEach(doc=>{
        const d=doc.data();
        const div=document.createElement("div");
        div.className="item";
        div.innerHTML=`
          <strong>ØªØ§Ø±ÙŠØ®:</strong> ${d.createdAt}<br>
          <a href="${d.svg}" target="_blank">ğŸ–¼ï¸ ØªØ­Ù…ÙŠÙ„ SVG</a>
          <a href="${d.csv}" target="_blank">ğŸ“„ ØªØ­Ù…ÙŠÙ„ CSV</a>
          <iframe src="${d.svg}" width="200" height="200"></iframe>
        `;
        list.appendChild(div);
      });
    }

    document.getElementById('convert').addEventListener('click',async()=>{
      if(!lastImg){alert('Ø§Ø®ØªØ± ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹');return;}
      const cellSize=parseInt(document.getElementById('cellSize').value)||8;
      const out=await convertImage(lastImg,cellSize);
      const svgBlob=new Blob([out.svg],{type:'image/svg+xml'});
      const csvBlob=new Blob([out.csv],{type:'text/csv'});
      const svgUrlLocal=URL.createObjectURL(svgBlob);

      // Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
      document.getElementById('preview').src=svgUrlLocal;

      // Ø²Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ù„ÙŠ
      const dl=document.getElementById('downloadLink');
      dl.href=svgUrlLocal;
      dl.style.display="inline-block";

      // Ø§Ù„Ø±ÙØ¹ Ø¥Ù„Ù‰ Firebase
      const {svgUrl,csvUrl} = await savePattern(svgBlob,csvBlob);
      alert("âœ… ØªÙ… Ø±ÙØ¹ Ø§Ù„Ù…Ø®Ø·Ø·:\n"+svgUrl+"\n"+csvUrl);

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      loadPatterns();
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    loadPatterns();
  </script>
</body>
</html>
